%define CODE_JUMP 0x600
%define STACK_JUMP 0x200
%define CS_OFFSET -0x1
%define ZOMBIES_TIMER 0X0122

delete_this:
    mov [0], ax
    add word [0], zombie
    
jmp after_zombie
zombie:
	
	push ss
	pop ds
	
    push cs
	pop es
	
	push cs
	pop ss
	
	mov bx,0x50
	adress_put_here:
	mov word [bx], 0x00A2 ;need to add here the addres
	mov word [bx + 2], 0x1000 + CS_OFFSET
	
	mov word [0], 0xcccc
	mov word [2], 0xffcc
	mov word [4], 0xcc1f
	mov word [6], 0xcccc
	
	
    mov si,start - start_Copy + 2
    mov word [bx + (update_sp_si_flag - start_Copy)], STACK_JUMP
	mov word [bx + (update_di_si_flag - start_Copy)],CODE_JUMP + (end_Copy-start_Copy - 2) ;
    mov bp, CODE_JUMP
	
	sub word [bx], CODE_JUMP
	
	mov dx, ZOMBIES_TIMER
    mov sp, ax;TODO - change this to a real switch
	mov di, sp
    call far [bx]
after_zombie:
    

mov cx , ((end_Copy - start_Copy)/ 2)
mov si, ax

mov byte [si+(adress_put_here+3)], ah

lea si, [si + start_Copy]
rep movsw

push ds 
push es
pop ds
pop es

mov bx , 0x50
mov al , 0xA2
mov [bx],ax


push cs
pop ss
mov sp, ax ;put sp in the right place

xor di, di ; timer

mov word [bx + 2], 0x1000 + CS_OFFSET

mov word [bx + (update_sp_si_flag - start_Copy)], STACK_JUMP
mov word [bx + (update_di_si_flag - start_Copy)],CODE_JUMP + (end_Copy-start_Copy - 2) ;
mov bp, CODE_JUMP

sub word [bx], CODE_JUMP
mov di, [bx]
add di, 0x10 * CS_OFFSET

sub sp, STACK_JUMP

mov si,start - start_Copy
movsw
dec di
call far [bx]

start_Copy:

dec dx
movsw
movsw
jz kill
movsw
movsw
movsw
movsw
movsw
sub di, [bx + si]
movsw
dec di
call_far:
call far [bx]

start:
update_di_si_flag:
call far [bx]

movsw
movsw
movsw
sub word [bx], bp
movsw
sub sp, [bx + si]
movsw
update_sp_si_flag:
movsw
xor si,si
movsw
nop
end_Copy:
;need to make sure kill lands on a byte from cs of the call far bombing that kills for sure
nop
kill: